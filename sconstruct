#!/usr/bin/scons

prefix = ARGUMENTS.get("DESTDIR", "/")

env = Environment()
env.Append(CXXFLAGS = ["-g", "-Wall", "-pedantic", "-pthread", "-rdynamic"])
env.Append(CPPPATH = ["/usr/lib", "/usr/local/lib"])

library = env.SharedLibrary(
    target = "build/yappi",
    source = ["src/registry.cpp", "src/engines.cpp", "src/core.cpp"],
    CPPPATH = ["include"],
    LIBS = ["zmq", "crypto", "dl"],
    LINKFLAGS = ["-Wl,-soname=libyappi.so.1", "-Wl,-Bsymbolic"])

binary = env.Program(
    target = "build/yappi",
    source = ["src/main.cpp"],
    CPPPATH = ["include"],
    LIBS = ["yappi"],
    LIBPATH = ["build"])

env.Requires(binary, library)

Export(['env'])
plugins = SConscript("plugins/sconscript")

env.Alias("install", prefix)
env.Install(prefix + "usr/bin", binary)
env.Install(prefix + "usr/lib", library)
env.Install(prefix + "usr/lib/yappi", plugins)
